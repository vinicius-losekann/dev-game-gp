<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo de Ger√™ncia de Projetos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #e8f0f2;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
        }
        .container {
            background-color: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            max-width: 600px;
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .header {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        .header img {
            width: 100%;
            height: auto;
            margin-bottom: 20px;
            display: block;
        }
        .header h1 {
            font-family: 'Poppins', sans-serif;
            color: #2e7d32;
            font-size: 2.5em;
            margin: 0;
        }
        .header .game-objective {
            margin-top: 10px;
            line-height: 1.6;
        }
        .header .instructions-list {
            text-align: left;
            margin-top: 10px;
            line-height: 1.6;
            padding-left: 20px;
            list-style-type: decimal;
        }
        .header .instructions-list li {
            margin-bottom: 8px;
        }
        .language-selection {
            margin: 20px 0;
        }
        .language-selection button {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .language-selection button:hover,
        .language-selection button.selected {
            background-color: #e0e0e0;
        }
        .cards {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 30px;
        }
        .card {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            width: 100%;
            box-sizing: border-box;
            text-align: left;
        }
        .card h2 {
            font-family: 'Poppins', sans-serif;
            margin-top: 0;
            color: #555;
            font-size: 1.5em;
        }
        .card form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .card input[type="text"] {
            font-family: 'Roboto', sans-serif;
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .card button {
            font-family: 'Roboto', sans-serif;
            background-color: #43a047;
            color: #fff;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        .card button:hover {
            background-color: #388e3c;
        }
        .footer {
            margin-top: 40px;
            color: #999;
            font-size: 0.9em;
        }
        #error-message {
            color: red;
            margin-top: 10px;
            font-size: 0.9em;
            text-align: center;
        }
        .session-display {
            background-color: #e8f5e9;
            color: #388e3c;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            text-align: center;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
        }
        .session-display.visible {
            display: flex;
            opacity: 1;
        }
        .session-display h3 {
            font-family: 'Poppins', sans-serif;
            color: #2e7d32;
            margin: 0;
            font-size: 1.2em;
        }
        .session-display p {
            margin: 0;
            font-size: 0.9em;
            color: #555;
        }
        .session-display .code {
            font-family: 'Poppins', sans-serif;
            font-size: 2em;
            font-weight: bold;
            color: #388e3c;
            letter-spacing: 2px;
        }
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <img src="https://github.com/vinicius-losekann/dev-game-gp/blob/refatorado/data/imgs/logo-jogo.png?raw=true" alt="Logo do Jogo de Ger√™ncia de Projetos">
            <h1 id="main-title">Jogo de Ger√™ncia de Projetos</h1>
            
            <p id="game-objective" class="game-objective">
                Este jogo foi criado para ajudar voc√™ a aprender, revisar e aplicar conceitos fundamentais de gerenciamento de projetos de forma interativa e divertida. Teste suas habilidades e conhecimentos em diversas √°reas para se tornar um gerente de projetos de sucesso.
            </p>

            <p class="instructions-heading">
                <b id="instructions-title">Instru√ß√µes:</b>
            </p>

            <ol class="instructions-list" id="instructions-list">
                <li>Escolha seu idioma.</li>
                <li>Inicie uma nova sess√£o ou junte-se a uma j√° existente.</li>
                <li>Teste suas habilidades em diversas √°reas de conhecimento.</li>
            </ol>
        </div>

        <div class="language-selection" id="language-selection">
        </div>

        <div class="cards">
            <div class="card">
                <h2 id="new-game-title">Iniciar um Novo Jogo</h2>
                <form id="new-game-form">
                    <button type="button" id="new-game-button">Criar Nova Sess√£o</button>
                </form>
                <div id="session-display" class="session-display">
                    <h3 id="session-title">Sess√£o Criada! üéâ</h3>
                    <p id="session-message">Compartilhe o c√≥digo da sess√£o com os outros jogadores:</p>
                    <span class="code" id="session-code-display"></span>
                </div>
            </div>
            
            <div class="card">
                <h2 id="join-session-title">Entrar em uma Sess√£o Existente</h2>
                <form id="join-session-form">
                    <input type="text" id="username-join" placeholder="Seu nome de usu√°rio" required>
                    <input type="text" id="session-code" placeholder="C√≥digo da sess√£o" required>
                    <button type="submit" id="join-session-button">Entrar na Sess√£o</button>
                </form>
            </div>
        </div>
        
        <p id="error-message"></p>

        <div class="footer">
            <p><span id="game-version-text">Vers√£o do Jogo:</span> <span id="game-version">1.0.0</span></p>
        </div>
    </div>

    <script type="module">
        // Importa as fun√ß√µes do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // --- Configura√ß√£o do Firebase ---
        console.log("Script carregado. Inicializando Firebase...");
        const firebaseConfig = {
            apiKey: "AIzaSyDdiedj1Smjzn9CDqShdhG5Y0_Sa18xyWI",
            authDomain: "jogo-gerencia-de-projetos.firebaseapp.com",
            projectId: "jogo-gerencia-de-projetos",
            storageBucket: "jogo-gerencia-de-projetos.firebasestorage.app",
            messagingSenderId: "356867532123",
            appId: "1:356867532123:web:0657d84635a5849df2667e",
            measurementId: "G-M5QYQ36Q9P"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const APP_ID = firebaseConfig.appId;
        console.log("Firebase inicializado com sucesso.");

        // --- L√≥gica de Tradu√ß√£o e UI ---
        // As vari√°veis 'config' e 'translations' e a fun√ß√£o 'updateContent' foram movidas para este local
        // para garantir que sejam definidas antes de serem usadas.
        const config = {
            languages: [
                { code: 'pt-BR', name: 'Portugu√™s (BR)' },
                { code: 'en-US', name: 'Ingl√™s (US)' },
                { code: 'es-ES', name: 'Espanhol (ES)' }
            ]
        };

        const translations = {
            'pt-BR': {
                title: 'Jogo de Ger√™ncia de Projetos',
                objective: 'Este jogo foi criado para ajudar voc√™ a aprender, revisar e aplicar conceitos fundamentais de gerenciamento de projetos de forma interativa e divertida. Teste suas habilidades e conhecimentos em diversas √°reas para se tornar um gerente de projetos de sucesso.',
                instructionsTitle: 'Instru√ß√µes:',
                instructions: [
                    'Escolha seu idioma.',
                    'Inicie uma nova sess√£o ou junte-se a uma j√° existente.',
                    'Teste suas habilidades em diversas √°reas de conhecimento.'
                ],
                newGameTitle: 'Iniciar um Novo Jogo',
                newGameButton: 'Criar Nova Sess√£o',
                sessionTitle: 'Sess√£o Criada! üéâ',
                sessionMessage: 'Compartilhe o c√≥digo da sess√£o com os outros jogadores:',
                joinSessionTitle: 'Entrar em uma Sess√£o Existente',
                usernamePlaceholder: 'Seu nome de usu√°rio',
                sessionCodePlaceholder: 'C√≥digo da sess√£o',
                joinSessionButton: 'Entrar na Sess√£o',
                versionText: 'Vers√£o do Jogo: ',
                creatingSession: "Criando nova sess√£o...",
                sessionCreated: "Sess√£o criada! Compartilhe o c√≥digo.",
                validatingSession: "Verificando sess√£o...",
                joinSuccess: "Entrando na sess√£o...",
                invalidSession: "O c√≥digo da sess√£o n√£o √© v√°lido. Verifique e tente novamente.",
                fieldsRequired: "Por favor, preencha todos os campos."
            },
            'en-US': {
                title: 'Project Management Game',
                objective: 'This game was created to help you learn, review, and apply fundamental project management concepts in an interactive and fun way. Test your skills and knowledge in various areas to become a successful project manager.',
                instructionsTitle: 'Instructions:',
                instructions: [
                    'Choose your language.',
                    'Start a new session or join an existing one.',
                    'Test your skills in various knowledge areas.'
                ],
                newGameTitle: 'Start a New Game',
                newGameButton: 'Create New Session',
                sessionTitle: 'Session Created! üéâ',
                sessionMessage: 'Share the session code with other players:',
                joinSessionTitle: 'Join an Existing Session',
                usernamePlaceholder: 'Your username',
                sessionCodePlaceholder: 'Session code',
                joinSessionButton: 'Join Session',
                versionText: 'Game Version: ',
                creatingSession: "Creating new session...",
                sessionCreated: "Session created! Share the code.",
                validatingSession: "Verifying session...",
                joinSuccess: "Joining session...",
                invalidSession: "The session code is not valid. Please check and try again.",
                fieldsRequired: "Please fill in all fields."
            },
            'es-ES': {
                title: 'Juego de Gesti√≥n de Proyectos',
                objective: 'Este juego fue creado para ayudarte a aprender, revisar y aplicar conceptos fundamentales de gesti√≥n de proyectos de forma interactiva y divertida. Pon a prueba tus habilidades y conocimientos en diversas √°reas para convertirte en un gestor de proyectos exitoso.',
                instructionsTitle: 'Instrucciones:',
                instructions: [
                    'Elige tu idioma.',
                    'Inicia una nueva sesi√≥n o √∫nete a una ya existente.',
                    'Pon a prueba tus habilidades en diversas √°reas de conocimiento.'
                ],
                newGameTitle: 'Crear un Nuevo Juego',
                newGameButton: 'Crear nueva sesi√≥n',
                sessionTitle: '¬°Sesi√≥n creada! üéâ',
                sessionMessage: 'Comparte el c√≥digo de la sesi√≥n con los otros jugadores:',
                joinSessionTitle: '√önete a una sesi√≥n existente',
                usernamePlaceholder: 'Tu nombre de usuario',
                sessionCodePlaceholder: 'C√≥digo de la sesi√≥n',
                joinSessionButton: 'Unirse a la sesi√≥n',
                versionText: 'Versi√≥n del juego: ',
                creatingSession: "Creando nueva sesi√≥n...",
                sessionCreated: "¬°Sesi√≥n creada! Comparte el c√≥digo.",
                validatingSession: "Verificando sesi√≥n...",
                joinSuccess: "Uni√©ndote a la sesi√≥n...",
                invalidSession: "El c√≥digo de la sesi√≥n no es v√°lido. Por favor, verifica y vuelve a intentarlo.",
                fieldsRequired: "Por favor, completa todos los campos."
            }
        };

        function updateContent(langCode) {
            const lang = translations[langCode] || translations['pt-BR'];
            document.title = lang.title;
            document.getElementById('main-title').textContent = lang.title;
            document.getElementById('game-objective').textContent = lang.objective;
            document.getElementById('instructions-title').textContent = lang.instructionsTitle;
            const instructionsList = document.getElementById('instructions-list');
            instructionsList.innerHTML = '';
            lang.instructions.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                instructionsList.appendChild(li);
            });
            document.getElementById('new-game-title').textContent = lang.newGameTitle;
            document.getElementById('new-game-button').textContent = lang.newGameButton;
            document.getElementById('join-session-title').textContent = lang.joinSessionTitle;
            document.getElementById('username-join').placeholder = lang.usernamePlaceholder;
            document.getElementById('session-code').placeholder = lang.sessionCodePlaceholder;
            document.getElementById('join-session-button').textContent = lang.joinSessionButton;
            document.getElementById('game-version-text').textContent = lang.versionText;
            document.getElementById('session-title').textContent = lang.sessionTitle;
            document.getElementById('session-message').textContent = lang.sessionMessage;

            document.querySelectorAll('.language-selection button').forEach(button => {
                button.classList.remove('selected');
            });
            const selectedButton = document.querySelector(`button[data-lang="${langCode}"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
            }
        }

        const langContainer = document.getElementById('language-selection');
        config.languages.forEach(lang => {
            const button = document.createElement('button');
            button.textContent = lang.name;
            button.setAttribute('data-lang', lang.code);
            button.onclick = () => updateContent(lang.code);
            langContainer.appendChild(button);
        });

        // --- L√≥gica de Jogo (Firebase) ---
        const sessionDisplay = document.getElementById('session-display');
        const newGameButton = document.getElementById('new-game-button');
        const sessionCodeInput = document.getElementById('session-code');
        const sessionCodeDisplay = document.getElementById('session-code-display');
        const errorMessageElement = document.getElementById('error-message');

        function showMessage(message, color = 'red') {
            errorMessageElement.textContent = message;
            errorMessageElement.style.color = color;
        }

        newGameButton.addEventListener('click', async () => {
            const langCode = document.querySelector('.language-selection button.selected')?.getAttribute('data-lang') || 'pt-BR';
            const lang = translations[langCode];
            
            showMessage(lang.creatingSession, 'green');
            console.log("Bot√£o 'Criar Nova Sess√£o' clicado. Iniciando autentica√ß√£o an√¥nima...");
            
            try {
                const userCredential = await signInAnonymously(auth);
                const userId = userCredential.user.uid;
                console.log(`Autentica√ß√£o an√¥nima bem-sucedida. UID do usu√°rio: ${userId}`);

                const sessionsCollectionRef = `artifacts/${APP_ID}/public/data/sessions`;
                const newSessionRef = doc(db, sessionsCollectionRef);
                const sessionId = newSessionRef.id;
                console.log(`ID da nova sess√£o gerado: ${sessionId}`);
                
                await setDoc(doc(db, sessionsCollectionRef, sessionId), {
                    createdAt: new Date(),
                    hostUserId: userId
                });
                console.log("Documento de sess√£o criado no Firestore com sucesso.");

                sessionCodeDisplay.textContent = sessionId;
                sessionCodeInput.value = sessionId;
                sessionDisplay.classList.add('visible');
                showMessage(lang.sessionCreated, 'green');

            } catch (error) {
                console.error("Erro ao criar a sess√£o:", error);
                showMessage("Erro ao criar a sess√£o. Por favor, tente novamente.", 'red');
            }
        });

        document.getElementById('join-session-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username-join').value.trim();
            const sessionCode = document.getElementById('session-code').value.trim();
            const langCode = document.querySelector('.language-selection button.selected')?.getAttribute('data-lang') || 'pt-BR';
            const lang = translations[langCode];

            if (!username || !sessionCode) {
                showMessage(lang.fieldsRequired);
                console.log("Campos de formul√°rio vazios.");
                return;
            }

            showMessage(lang.validatingSession, 'green');
            console.log(`Tentando entrar na sess√£o: '${sessionCode}' com o usu√°rio: '${username}'`);
            
            try {
                const userCredential = await signInAnonymously(auth);
                const userId = userCredential.user.uid;
                console.log(`Autentica√ß√£o an√¥nima bem-sucedida. UID do usu√°rio: ${userId}`);

                const sessionRef = doc(db, `artifacts/${APP_ID}/public/data/sessions/${sessionCode}`);
                console.log(`Verificando o caminho: artifacts/${APP_ID}/public/data/sessions/${sessionCode}`);
                const sessionSnap = await getDoc(sessionRef);

                if (sessionSnap.exists()) {
                    console.log("Sess√£o encontrada. Adicionando jogador...");
                    const playerRef = doc(db, `artifacts/${APP_ID}/public/data/sessions/${sessionCode}/players/${userId}`);
                    await setDoc(playerRef, {
                        name: username,
                        score: 0,
                        lastActive: new Date()
                    });
                    console.log(`Jogador '${username}' adicionado √† subcole√ß√£o 'players'.`);

                    showMessage(lang.joinSuccess, 'green');
                    window.location.href = `game.html?session=${encodeURIComponent(sessionCode)}&username=${encodeURIComponent(username)}&lang=${encodeURIComponent(langCode)}&userId=${encodeURIComponent(userId)}`;
                } else {
                    showMessage(lang.invalidSession, 'red');
                    console.warn("Sess√£o n√£o encontrada no Firestore.");
                }
            } catch (error) {
                console.error("Erro ao entrar na sess√£o:", error);
                showMessage("Erro ao entrar na sess√£o. Verifique sua conex√£o e o c√≥digo.", 'red');
            }
        });
        
        // Inicializa o conte√∫do da p√°gina com o idioma padr√£o
        updateContent('pt-BR');
    </script>
</body>
</html>

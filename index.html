<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="main_page_title">Jogo de Gerenciamento de Projetos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Importa seu arquivo de estilo CSS personalizado -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Overlay de carregamento, inicialmente visível -->
    <div id="loadingOverlay" class="loading-overlay">
        Carregando...
    </div>

    <!-- Script para carregar configurações globais da aplicação (AppConfig) -->
    <!-- Este script DEVE ser carregado antes de qualquer script que dependa de suas variáveis,
         exceto pelas variáveis intrínsecas do ambiente Canvas como __firebase_config e __app_id. -->
    <script src="js/config.js"></script>

    <!-- Script para inicializar o Firebase e definir a promessa de inicialização -->
    <!-- Este script DEVE ser carregado antes de 'index.js' para garantir que window.firebaseInitializedPromise exista -->
    <script type="module">
        // Importa as funções necessárias do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Define uma promessa global para sinalizar quando o Firebase estiver inicializado
        // e as instâncias de db e auth estiverem disponíveis em window.
        window.firebaseInitializedPromise = new Promise(async (resolve) => {
            let firebaseConfig = {};
            let appId = 'default-app-id'; // Fallback padrão

            // Tenta obter __app_id do ambiente Canvas, com fallback
            if (typeof __app_id !== 'undefined') {
                appId = __app_id;
                console.log(`Firebase (index.html): __app_id lido: ${appId}`);
            } else {
                console.warn("Firebase (index.html): __app_id não definido no ambiente Canvas. Usando 'default-app-id'.");
            }

            // Tenta obter e analisar __firebase_config do ambiente Canvas
            if (typeof __firebase_config !== 'undefined') {
                try {
                    firebaseConfig = JSON.parse(__firebase_config);
                    console.log("Firebase (index.html): __firebase_config lido e analisado com sucesso.");
                    // console.log("Firebase Config:", firebaseConfig); // Evitar logar a config completa em produção
                } catch (e) {
                    console.error("Firebase (index.html): Erro ao analisar __firebase_config:", e);
                    firebaseConfig = {};
                }
            } else {
                console.warn("Firebase (index.html): __firebase_config não definido no ambiente Canvas.");
            }

            // Apenas inicializa o Firebase se a configuração for válida
            if (Object.keys(firebaseConfig).length > 0 && appId !== 'default-app-id') {
                try {
                    const appInstance = initializeApp(firebaseConfig);
                    const authInstance = getAuth(appInstance);
                    const dbInstance = getFirestore(appInstance);

                    // Expõe as instâncias globalmente para outros scripts (gameLogic.js, index.js)
                    window.app = appInstance;
                    window.auth = authInstance;
                    window.db = dbInstance;
                    // Exporta as funções do firestore que serão usadas no gameLogic e index (se necessário)
                    // Não é o objeto completo, apenas as funções que são importadas nos outros arquivos
                    window.firestore = {
                        collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot
                    };


                    // Autenticação: tenta com token customizado primeiro, depois anonimamente.
                    // __initial_auth_token é fornecido pelo ambiente Canvas.
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(authInstance, __initial_auth_token);
                        console.log("Firebase (game.html): Autenticado com token personalizado.");
                    } else {
                        await signInAnonymously(authInstance);
                        console.log("Firebase (game.html): Autenticado anonimamente.");
                    }

                    // Define o ID do usuário globalmente.
                    // Isso é importante porque auth.currentUser pode ser null brevemente após a inicialização.
                    // onAuthStateChanged seria a forma mais robusta, mas para este caso, o `await` já ajuda.
                    window.currentUserId = authInstance.currentUser.uid;
                    console.log(`Firebase (game.html): App inicializado e autenticado. ID do Usuário: ${window.currentUserId}`);

                    resolve(); // Resolve a promessa indicando sucesso na inicialização
                } catch (error) {
                    console.error("Erro na inicialização ou autenticação do Firebase:", error);
                    resolve(); // Resolve mesmo em erro para não bloquear o DOMContentLoaded
                }
            } else {
                console.error("Firebase: Configuração não encontrada ou inválida. Inicialização pulada. Isso pode ocorrer se o ambiente Canvas não fornecer a configuração.");
                resolve(); // Resolve para não bloquear a execução do DOMContentLoaded
            }
        });
    </script>
    <!-- Inclua o script principal (index.js) como um módulo -->
    <script type="module" src="js/index.js"></script>
</body>
</html>

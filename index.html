<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo de Gerência de Projetos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ... seu CSS existente ... */
    </style>
</head>
<body>

    <div class="container">
        </div>

    <script type="module">
        // Importa as funções do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Adiciona um log para confirmar que o script foi carregado
        console.log("Script carregado. Iniciando a configuração do Firebase...");

        const firebaseConfig = {
            apiKey: "AIzaSyDdiedj1Smjzn9CDqShdhG5Y0_Sa18xyWI",
            authDomain: "jogo-gerencia-de-projetos.firebaseapp.com",
            projectId: "jogo-gerencia-de-projetos",
            storageBucket: "jogo-gerencia-de-projetos.firebasestorage.app",
            messagingSenderId: "356867532123",
            appId: "1:356867532123:web:0657d84635a5849df2667e"
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const APP_ID = firebaseConfig.appId;

        // Log para confirmar que as instâncias foram criadas
        console.log("Instâncias do Firebase criadas: app, db, auth.");

        const translations = {
            // ... suas traduções existentes ...
        };

        function updateContent(langCode) {
            // ... sua função updateContent existente ...
        }

        const langContainer = document.getElementById('language-selection');
        config.languages.forEach(lang => {
            // ... sua lógica para criar botões de idioma existente ...
        });

        const sessionDisplay = document.getElementById('session-display');
        const newGameButton = document.getElementById('new-game-button');
        const sessionCodeInput = document.getElementById('session-code');
        const sessionCodeDisplay = document.getElementById('session-code-display');
        const errorMessageElement = document.getElementById('error-message');

        function showMessage(message, color = 'red') {
            errorMessageElement.textContent = message;
            errorMessageElement.style.color = color;
            setTimeout(() => {
                errorMessageElement.textContent = '';
            }, 5000);
        }

        newGameButton.addEventListener('click', async () => {
            showMessage("Criando nova sessão...", 'green');
            console.log("Botão 'Novo Jogo' clicado. Iniciando autenticação anônima...");
            try {
                // 1. Autenticação Anônima
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                const userId = user.uid;
                console.log(`Autenticação anônima bem-sucedida. User ID: ${userId}`);

                // 2. Criação do Documento no Firestore
                const sessionsCollectionPath = `artifacts/${APP_ID}/public/data/sessions`;
                console.log(`Caminho da coleção de sessões: ${sessionsCollectionPath}`);
                
                const newSessionRef = doc(db, sessionsCollectionPath);
                console.log("Tentando criar novo documento de sessão...");
                
                await setDoc(newSessionRef, {
                    createdAt: new Date(),
                    hostUserId: userId
                });
                const sessionId = newSessionRef.id;
                console.log(`Documento de sessão criado com sucesso! Session ID: ${sessionId}`);

                // 3. Exibe o código da sessão gerado
                sessionCodeDisplay.textContent = sessionId;
                sessionCodeInput.value = sessionId;
                sessionDisplay.classList.add('visible');
                showMessage("Sessão criada! Compartilhe o código.", 'green');

            } catch (error) {
                console.error("Erro ao criar sessão: ", error);
                showMessage("Erro ao criar a sessão. Tente novamente mais tarde.");
            }
        });

        document.getElementById('join-session-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username-join').value.trim();
            const sessionCode = document.getElementById('session-code').value.trim();
            const langCode = document.querySelector('.language-selection button.selected').getAttribute('data-lang') || 'pt-BR';

            if (!username || !sessionCode) {
                showMessage('Por favor, preencha todos os campos.');
                console.log("Dados de formulário incompletos. Ação abortada.");
                return;
            }

            showMessage("Verificando sessão...", 'green');
            console.log(`Tentando entrar na sessão '${sessionCode}' como '${username}'.`);
            try {
                // Autentica o usuário anonimamente antes de tentar se juntar
                const userCredential = await signInAnonymously(auth);
                const userId = userCredential.user.uid;
                console.log(`Autenticação anônima para entrar na sessão. User ID: ${userId}`);

                // Verifica se a sessão existe
                const sessionRef = doc(db, `artifacts/${APP_ID}/public/data/sessions/${sessionCode}`);
                console.log(`Caminho da sessão: artifacts/${APP_ID}/public/data/sessions/${sessionCode}`);
                
                const sessionSnap = await getDoc(sessionRef);

                if (sessionSnap.exists()) {
                    console.log("Sessão encontrada no Firestore. Adicionando jogador...");
                    // Adiciona o jogador à subcoleção 'players'
                    const playerRef = doc(db, `artifacts/${APP_ID}/public/data/sessions/${sessionCode}/players/${userId}`);
                    await setDoc(playerRef, {
                        name: username,
                        score: 0,
                        lastActive: new Date(),
                        answeredQuestions: {}
                    });
                    console.log(`Jogador '${username}' adicionado à sessão '${sessionCode}'.`);

                    // Redireciona para game.html com os parâmetros na URL
                    window.location.href = `game.html?session=${encodeURIComponent(sessionCode)}&username=${encodeURIComponent(username)}&lang=${encodeURIComponent(langCode)}&userId=${encodeURIComponent(userId)}`;
                } else {
                    showMessage("O código da sessão não é válido. Verifique e tente novamente.");
                    console.warn("Sessão não encontrada. O código pode estar incorreto.");
                }
            } catch (error) {
                console.error("Erro ao entrar na sessão: ", error);
                showMessage("Erro ao entrar na sessão. Verifique sua conexão e o código.");
            }
        });

        // Log final para indicar que o script de setup foi concluído
        console.log("Setup do script concluído.");
        updateContent('pt-BR');
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title> <!-- Título vazio, será definido via JS -->
    <!-- Incluindo Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluindo estilos personalizados -->
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Esconde o conteúdo principal instantaneamente para evitar o "flash" */
        #main-content-container {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
        }
    </style>
    <!-- Incluindo Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Variáveis globais para Firebase, que serão preenchidas no DOMContentLoaded
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null; // Adicionado para armazenar o UID do usuário
        window.serverTimestamp = serverTimestamp; // Expondo serverTimestamp globalmente

        document.addEventListener('DOMContentLoaded', async () => {
            // As variáveis __app_id e __firebase_config são fornecidas pelo ambiente Canvas.
            // Se você não estiver no ambiente Canvas (ex: testando localmente),
            // você precisará preencher 'firebaseConfig' manualmente com seus próprios valores.
            // Para encontrar seus valores: Vá ao console do Firebase > Configurações do Projeto (⚙️) > Seus apps > Web.
            const manualFirebaseConfig = {
                apiKey: "SUA_API_KEY_AQUI", // EX: "AIzaSyC...XYZ"
                authDomain: "SEU_AUTH_DOMAIN_AQUI.firebaseapp.com", // EX: "meu-projeto-12345.firebaseapp.com"
                projectId: "SEU_PROJECT_ID_AQUI", // EX: "meu-projeto-12345"
                storageBucket: "SEU_STORAGE_BUCKET_AQUI.appspot.com",
                messagingSenderId: "SEU_MESSAGING_SENDER_ID_AQUI",
                appId: "SEU_APP_ID_AQUI",
                measurementId: "SEU_MEASUREMENT_ID_AQUI"
            };

            const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : manualFirebaseConfig;
            // O appId do Firebase no Canvas é um identificador para o seu aplicativo.
            // Se estiver fora do Canvas, use o ID do seu projeto Firebase ou um valor padrão.
            const finalAppId = typeof __app_id !== 'undefined' ? __app_id : manualFirebaseConfig.projectId || 'gameGP'; 

            try {
                window.firebaseApp = initializeApp(finalFirebaseConfig);
                window.auth = getAuth(window.firebaseApp);
                window.db = getFirestore(window.firebaseApp);
                window.appId = finalAppId; // Torna o appId globalmente acessível

                // Autenticação: Tenta usar o token customizado (Canvas), caso contrário, faz login anônimo
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                    console.log("Firebase: Autenticado com token customizado.");
                } else {
                    await signInAnonymously(window.auth);
                    console.log("Firebase: Autenticado anonimamente.");
                }
                
                // O UID do usuário autenticado é usado como currentUserId
                window.currentUserId = window.auth.currentUser?.uid || 'anonymous-user';

                console.log("Firebase: App inicializado e autenticado. ID do Usuário:", window.currentUserId);

                // Torna o conteúdo principal visível apenas após a inicialização bem-sucedida do Firebase e autenticação
                const mainContent = document.getElementById('main-content-container');
                if (mainContent) {
                    mainContent.style.opacity = '1';
                    mainContent.style.visibility = 'visible';
                }

            } catch (error) {
                console.error("Erro ao inicializar Firebase ou autenticar:", error);
                const mainContent = document.getElementById('main-content-container');
                if (mainContent) {
                    mainContent.innerHTML = `<p class="text-red-600 text-center text-lg font-semibold mt-8">Erro crítico: Não foi possível conectar ao Firebase. Por favor, recarregue a página e verifique:</p>
                                             <ul class="list-disc list-inside text-left mx-auto max-w-sm mt-4 text-gray-700">
                                                <li>Seu projeto Firebase está configurado corretamente.</li>
                                                <li>Autenticação Anônima está habilitada.</li>
                                                <li>Firestore Database está configurado.</li>
                                                <li>Se estiver testando localmente, preencheu as chaves em `manualFirebaseConfig` no HTML.</li>
                                             </ul>`;
                    mainContent.style.opacity = '1';
                    mainContent.style.visibility = 'visible';
                }
            }
        });
    </script>
</head>
<body class="p-4 flex flex-col min-h-screen">
    <div id="main-content-container" class="container bg-white p-10 rounded-2xl shadow-2xl max-w-lg w-full text-center border-b-4 border-teal-500 flex-grow">
        <h1 id="mainTitle" class="text-5xl font-extrabold text-teal-700 mb-6 drop-shadow-sm">
            Jogo de Gerenciamento de Projetos
        </h1>
        <p id="descriptionText" class="text-xl text-gray-800 leading-relaxed mb-8">
            Domine as habilidades essenciais de gerenciamento de projetos neste jogo interativo! Aprenda sobre **planejamento**, **execução**, **monitoramento de progresso** e **resolução de desafios** em cenários simulados para se tornar um gestor de projetos de sucesso. Cada decisão importa!
        </p>

        <div class="mb-6">
            <button id="newGameButton" class="game-button bg-gradient-to-r from-teal-500 to-green-500 hover:from-teal-600 hover:to-green-600 text-white font-bold py-4 px-8 rounded-full text-xl focus:outline-none focus:ring-4 focus:ring-teal-300 focus:ring-opacity-75" disabled>
                <span data-lang-key="button_new_game">Iniciar Novo Jogo</span>
            </button>
            <div id="sessionInfo" class="session-info hidden mt-4">
                <!-- Mensagem da sessão criada será exibida aqui -->
            </div>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-200">
            <h2 id="accessGameTitle" class="text-2xl font-bold text-gray-700 mb-4">
                Acessar Jogo Existente
            </h2>
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <input type="text" id="sessionIdInput" placeholder="Digite o ID da Sessão" class="game-input">
                <button id="accessGameButton" class="game-button bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" disabled>
                    <span data-lang-key="button_access_game">Acessar Jogo</span>
                </button>
            </div>
            <div id="errorMessage" class="mt-4 text-red-600 hidden">
                <!-- Mensagem de erro para ID de sessão inválido -->
            </div>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-200">
            <h2 id="languageSelectTitle" class="text-2xl font-bold text-gray-700 mb-4">
                Idioma
            </h2>
            <div class="flex justify-center gap-2">
                <button id="langPtBrButton" class="language-button py-2 px-4 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-800">Português</button>
                <button id="langEnUsButton" class="language-button py-2 px-4 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-800">English</button>
                <button id="langEsEsButton" class="language-button py-2 px-4 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-800">Español</button>
            </div>
        </div>
    </div>

    <!-- Indicador de Versão (agora no final do fluxo, empurrado pelo flex-grow) -->
    <div id="app-version" class="mt-auto text-gray-400 text-xs p-4 text-center w-full">
        Versão: 1.0.0
    </div>

    <!-- Incluindo arquivo de configuração -->
    <script src="js/config.js"></script>
    <!-- Incluindo JavaScript externo -->
    <script src="js/index.js"></script>
</body>
</html>

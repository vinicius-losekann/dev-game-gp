<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sessão do Jogo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #e8f0f2;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            color: #333;
            padding: 20px;
        }
        .container {
            background-color: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            max-width: 800px;
            width: 100%;
            text-align: center;
        }
        .header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            text-align: left;
        }
        .user-info {
            flex-grow: 1;
        }
        .user-info h2 {
            font-family: 'Poppins', sans-serif;
            color: #2e7d32;
            margin: 0 0 5px 0;
            font-size: 1.8em;
            font-weight: 600;
        }
        .user-info p {
            margin: 0;
            font-size: 1.1em;
            color: #555;
            font-weight: 500;
        }
        .game-stats {
            text-align: right;
        }
        .game-stats h2, .game-stats p {
            margin: 0;
            font-size: 1.2em;
            color: #555;
        }
        
        .game-area {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .game-card {
            background-color: #f9f9f9;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            width: 100%;
            box-sizing: border-box;
            text-align: left;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .game-card h2 {
            font-family: 'Poppins', sans-serif;
            color: #555;
            margin-top: 0;
            font-size: 1.5em;
            text-align: center;
        }
        .question-text {
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 20px;
            text-align: center;
        }
        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }
        .options button {
            font-family: 'Roboto', sans-serif;
            color: #fff;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        .options button:hover {
            opacity: 0.8;
        }
        /* Cores para os botões das áreas de conhecimento */
        #selection-buttons .btn-integ { background-color: #2e7d32; }
        #selection-buttons .btn-escopo { background-color: #1565c0; }
        #selection-buttons .btn-cronograma { background-color: #ffb300; }
        #selection-buttons .btn-custos { background-color: #c62828; }
        #selection-buttons .btn-qualidade { background-color: #6a1b9a; }
        #selection-buttons .btn-recursos { background-color: #e65100; }
        #selection-buttons .btn-comunicacao { background-color: #00897b; }
        #selection-buttons .btn-riscos { background-color: #455a64; }
        #selection-buttons .btn-aquisicoes { background-color: #5d4037; }
        #selection-buttons .btn-stakeholders { background-color: #d84315; }

        /* Estilo das alternativas de resposta */
        .option-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
            text-align: left;
            font-weight: 500;
        }
        .option-item:hover {
            border-color: #999;
        }
        .option-item::before {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #bbb;
            border-radius: 50%;
            margin-right: 15px;
            transition: border-color 0.3s;
        }
        .option-item.selected::before {
            border-color: #1976d2;
            background-color: #1976d2;
        }
        .options .disabled {
            pointer-events: none;
            opacity: 0.7;
        }
        .correct-answer {
            border-color: #2e7d32;
            color: #2e7d32;
        }
        .correct-answer::before {
            background-color: #2e7d32;
            border-color: #2e7d32;
        }
        .incorrect-answer {
            border-color: #c62828;
            color: #c62828;
        }
        .incorrect-answer::before {
            background-color: #c62828;
            border-color: #c62828;
        }

        #result-message {
            margin-top: 15px;
            font-size: 1.1em;
            font-weight: bold;
            display: none;
            text-align: center;
        }

        #explanation {
            margin-top: 20px;
            padding: 15px;
            background-color: #e0f2f1;
            border-left: 5px solid #004d40;
            border-radius: 5px;
            font-style: italic;
            line-height: 1.5;
            display: none;
            text-align: left;
        }
        .correct {
            color: #2e7d32;
        }
        .incorrect {
            color: #c62828;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .action-buttons button {
            background-color: #43a047;
            color: #fff;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        .action-buttons button:hover {
            background-color: #388e3c;
        }

        .footer {
            margin-top: 40px;
            color: #999;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .game-stats {
                text-align: left;
            }
            .game-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div class="user-info">
                <h2>Jogador: <span id="player-name"></span></h2>
                <p>Sessão: <span id="session-code"></span></p>
            </div>
            <div class="game-stats">
                <p>Pontuação: <span id="score">0</span></p>
                <p id="question-counter" style="display: none;">Pergunta <span id="current-question">1</span> de <span id="total-questions">10</span></p>
            </div>
        </div>

        <div class="game-area">
            <div class="game-card">
                <h2 id="main-title">Selecione uma Área de Conhecimento</h2>
                <p id="instruction-text">Clique em um dos botões abaixo para iniciar o desafio sobre a área selecionada.</p>
                <div id="selection-buttons" class="options">
                </div>
                <p id="question-text" class="question-text" style="display: none;"></p>
                <div id="options-container" class="options" style="display: none;">
                </div>
                <p id="result-message"></p>
                <div id="explanation" style="display: none;"></div>
                <div id="game-controls" class="action-buttons" style="display: none;">
                    <button id="back-button">Voltar para as Áreas</button>
                    <button id="next-question-button">Próxima Pergunta</button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Jogo de Gerência de Projetos v1.0.0</p>
        </div>
    </div>

    <div id="message-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <button id="modal-close-button">OK</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Configurações e Variáveis Globais ---
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user');
        const sessionId = urlParams.get('session');
        const language = urlParams.get('lang') || 'pt-BR'; // Assume pt-BR como padrão

        // Variáveis do Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        let app, db;
        let playerName, playerScore;
        let questionsByArea = {};
        let currentQuestionsList = [];
        let currentQuestionIndex = 0;
        let selectedArea = '';

        const areaColors = {
            "Integração": "btn-integ",
            "Escopo": "btn-escopo",
            "Cronograma": "btn-cronograma",
            "Custos": "btn-custos",
            "Qualidade": "btn-qualidade",
            "Recursos": "btn-recursos",
            "Comunicação": "btn-comunicacao",
            "Riscos": "btn-riscos",
            "Aquisições": "btn-aquisicoes",
            "Stakeholders": "btn-stakeholders"
        };

        // --- Elementos do DOM ---
        const playerNameElement = document.getElementById('player-name');
        const sessionCodeElement = document.getElementById('session-code');
        const scoreElement = document.getElementById('score');
        const mainTitleElement = document.getElementById('main-title');
        const instructionTextElement = document.getElementById('instruction-text');
        const selectionButtonsContainer = document.getElementById('selection-buttons');
        const questionTextElement = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const questionCounterElement = document.getElementById('question-counter');
        const currentQuestionElement = document.getElementById('current-question');
        const totalQuestionsElement = document.getElementById('total-questions');
        const resultMessageElement = document.getElementById('result-message');
        const explanationElement = document.getElementById('explanation');
        const nextQuestionButton = document.getElementById('next-question-button');
        const backButton = document.getElementById('back-button');
        const gameControls = document.getElementById('game-controls');
        
        // --- Funções de UI ---
        function showMessage(title, message) {
            const modal = document.getElementById('message-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            modal.style.display = 'flex';
        }
        
        function hideMessage() {
            document.getElementById('message-modal').style.display = 'none';
        }

        function showAreaSelection() {
            mainTitleElement.textContent = 'Selecione uma Área de Conhecimento';
            instructionTextElement.style.display = 'block';
            selectionButtonsContainer.style.display = 'flex';
            questionTextElement.style.display = 'none';
            optionsContainer.style.display = 'none';
            resultMessageElement.style.display = 'none';
            explanationElement.style.display = 'none';
            gameControls.style.display = 'none';
            questionCounterElement.style.display = 'none';
            document.querySelector('.game-card').style.justifyContent = 'center';
        }

        function loadQuestion() {
            if (currentQuestionIndex < currentQuestionsList.length) {
                const currentQuestion = currentQuestionsList[currentQuestionIndex];
                
                mainTitleElement.textContent = `Área: ${selectedArea}`;
                instructionTextElement.style.display = 'none';
                selectionButtonsContainer.style.display = 'none';
                questionCounterElement.style.display = 'block';
                questionTextElement.style.display = 'block';
                optionsContainer.style.display = 'flex';
                resultMessageElement.style.display = 'none';
                explanationElement.style.display = 'none';
                gameControls.style.display = 'none';
                nextQuestionButton.style.display = 'none';

                questionTextElement.textContent = currentQuestion.question;
                optionsContainer.innerHTML = '';
                
                const optionKeys = Object.keys(currentQuestion.options).sort();
                optionKeys.forEach(key => {
                    const optionDiv = document.createElement('div');
                    optionDiv.textContent = `${key}. ${currentQuestion.options[key]}`;
                    optionDiv.classList.add('option-item');
                    optionDiv.addEventListener('click', () => checkAnswer(key, currentQuestion.correct, currentQuestion.explanation, optionDiv));
                    optionsContainer.appendChild(optionDiv);
                });
                
                currentQuestionElement.textContent = currentQuestionIndex + 1;
                totalQuestionsElement.textContent = currentQuestionsList.length;
                document.querySelector('.game-card').style.justifyContent = 'flex-start';

            } else {
                endGame();
            }
        }

        async function checkAnswer(selectedOptionKey, correctAnswerKey, explanation, clickedElement) {
            const isCorrect = selectedOptionKey === correctAnswerKey;
            
            const allOptions = optionsContainer.querySelectorAll('.option-item');
            allOptions.forEach(option => {
                option.classList.add('disabled');
                // Encontra e destaca a resposta correta
                const optionKey = option.textContent.substring(0, 1);
                if (optionKey === correctAnswerKey) {
                    option.classList.add('correct-answer');
                }
            });
            
            if (isCorrect) {
                playerScore++;
                scoreElement.textContent = playerScore;
                resultMessageElement.textContent = 'Correto! 🎉';
                resultMessageElement.classList.remove('incorrect');
                resultMessageElement.classList.add('correct');
            } else {
                resultMessageElement.textContent = `Incorreto. A resposta correta era: ${correctAnswerKey}`;
                resultMessageElement.classList.remove('correct');
                resultMessageElement.classList.add('incorrect');
                clickedElement.classList.add('incorrect-answer');
            }
            
            resultMessageElement.style.display = 'block';
            explanationElement.innerHTML = `<strong>Explicação:</strong> ${explanation}`;
            explanationElement.style.display = 'block';
            nextQuestionButton.style.display = 'block';

            // Atualiza a pontuação do jogador no Firestore
            try {
                const playerRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionId, 'players', userId);
                await updateDoc(playerRef, { score: playerScore });
            } catch (error) {
                console.error("Erro ao atualizar a pontuação no Firestore:", error);
            }
        }

        function endGame() {
            mainTitleElement.textContent = 'Fim do Desafio!';
            questionTextElement.textContent = `Você completou as perguntas desta área. Sua pontuação final é ${playerScore} de ${currentQuestionsList.length}.`;
            optionsContainer.innerHTML = '';
            gameControls.style.display = 'flex';
            nextQuestionButton.style.display = 'none';
            explanationElement.style.display = 'none';
            resultMessageElement.style.display = 'none';
        }

        // --- Funções Firebase ---
        async function fetchQuestionsByArea() {
            try {
                const questionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'questions');
                const q = query(questionsRef, where("language", "==", language));
                const querySnapshot = await getDocs(q);
                
                querySnapshot.forEach(doc => {
                    const questionData = doc.data();
                    const area = questionData.area;
                    if (!questionsByArea[area]) {
                        questionsByArea[area] = [];
                    }
                    questionsByArea[area].push(questionData);
                });

                createAreaButtons();
            } catch (error) {
                console.error("Erro ao buscar perguntas:", error);
                showMessage('Erro', 'Não foi possível carregar as perguntas do jogo. Verifique sua conexão.');
            }
        }

        async function fetchPlayerInfo() {
            try {
                const playerRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionId, 'players', userId);
                const playerSnap = await getDoc(playerRef);

                if (playerSnap.exists()) {
                    const data = playerSnap.data();
                    playerName = data.name;
                    playerScore = data.score || 0;
                    playerNameElement.textContent = playerName;
                    scoreElement.textContent = playerScore;
                    sessionCodeElement.textContent = sessionId;
                } else {
                    showMessage('Erro', 'Dados do jogador não encontrados.');
                    setTimeout(() => window.location.href = 'index.html', 3000);
                }
            } catch (error) {
                console.error("Erro ao buscar dados do jogador:", error);
                showMessage('Erro', 'Não foi possível carregar as informações do seu perfil.');
                setTimeout(() => window.location.href = 'index.html', 3000);
            }
        }

        // --- Inicialização e Event Listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Verifica se os parâmetros essenciais estão presentes
            if (!userId || !sessionId) {
                showMessage('Erro', 'Sessão inválida. Você será redirecionado para a página inicial.');
                setTimeout(() => window.location.href = 'index.html', 3000);
                return;
            }

            // Inicializa o Firebase
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                showMessage('Erro', `Não foi possível iniciar o Firebase: ${error.message}`);
                return;
            }

            // Fecha o modal de mensagens
            document.getElementById('modal-close-button').addEventListener('click', hideMessage);

            // Carrega os dados do jogador e as perguntas
            await fetchPlayerInfo();
            await fetchQuestionsByArea();

            // Sincroniza a tela com o estado inicial
            showAreaSelection();

            // Adiciona os event listeners
            nextQuestionButton.addEventListener('click', () => {
                currentQuestionIndex++;
                loadQuestion();
            });

            backButton.addEventListener('click', () => {
                showAreaSelection();
                playerScore = 0; // Reseta a pontuação ao voltar
                scoreElement.textContent = playerScore;
            });
        });

        // Cria os botões de seleção de área após carregar as perguntas
        function createAreaButtons() {
            selectionButtonsContainer.innerHTML = '';
            const areas = Object.keys(questionsByArea);
            areas.forEach(area => {
                const button = document.createElement('button');
                button.textContent = area;
                button.classList.add(areaColors[area] || 'btn-default');
                button.addEventListener('click', () => {
                    selectedArea = area;
                    currentQuestionsList = questionsByArea[selectedArea];
                    currentQuestionIndex = 0;
                    loadQuestion();
                });
                selectionButtonsContainer.appendChild(button);
            });
        }
    </script>
</body>
</html>

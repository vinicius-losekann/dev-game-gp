<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title> <!-- Título vazio, será definido via JS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(240, 242, 245, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: #333;
            z-index: 1000;
        }

        .container.hidden {
            display: none;
        }

        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        /* Estilo para o botão "Aceder Sessão" no game.html - corrigido */
        #accessGameButton {
            color: #ffffff; /* Cor do texto branco */
        }
    </style>
</head>
<body>
    <!-- Overlay de carregamento, inicialmente visível -->
    <div id="loadingOverlay" class="loading-overlay">
        Carregando jogo...
    </div>

    <!-- Script para carregar configurações globais da aplicação (AppConfig) -->
    <script src="js/config.js"></script>

    <!-- Script de inicialização do Firebase para game.html -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Define uma promessa global para sinalizar quando o Firebase estiver inicializado
        window.firebaseInitializedPromise = new Promise(async (resolve, reject) => {
            let firebaseConfig = {};
            let appId = 'default-app-id'; // Valor de fallback
            let initialAuthToken = null;

            try {
                if (typeof __app_id !== 'undefined' && typeof __firebase_config !== 'undefined') {
                    appId = __app_id;
                    firebaseConfig = JSON.parse(__firebase_config);
                    initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    console.log("Firebase (game.html): Variáveis do Canvas obtidas diretamente.");
                } else {
                    console.warn("Firebase (game.html): Variáveis __app_id ou __firebase_config não definidas no ambiente Canvas. Usando fallbacks.");
                }
            } catch (e) {
                console.error("Firebase (game.html): Erro ao tentar obter variáveis do Canvas:", e);
            }

            if (Object.keys(firebaseConfig).length > 0 && appId !== 'default-app-id') {
                try {
                    const appInstance = initializeApp(firebaseConfig);
                    const authInstance = getAuth(appInstance);
                    const dbInstance = getFirestore(appInstance);

                    // Expõe as instâncias globalmente para outros scripts
                    window.app = appInstance;
                    window.auth = authInstance;
                    window.db = dbInstance;
                    window.appId = appId;

                    // Autenticação
                    if (initialAuthToken) {
                        await signInWithCustomToken(authInstance, initialAuthToken);
                        console.log("Firebase (game.html): Autenticado com token personalizado.");
                    } else {
                        await signInAnonymously(authInstance);
                        console.log("Firebase (game.html): Autenticado anonimamente.");
                    }

                    // Garante que currentUserId está definido após autenticação
                    window.currentUserId = authInstance.currentUser?.uid;
                    console.log(`Firebase (game.html): App inicializado e autenticado. ID do Usuário: ${window.currentUserId}`);
                    resolve(); // Resolve a promessa indicando sucesso
                } catch (error) {
                    console.error("Firebase (game.html): Erro na inicialização ou autenticação:", error);
                    reject(error); // Rejeita a promessa em caso de erro
                }
            } else {
                const errorMessage = "Firebase (game.html): Configuração final inválida. Inicialização pulada.";
                console.error(errorMessage);
                reject(new Error(errorMessage));
            }
        }).catch(error => {
            // Captura qualquer erro de inicialização para garantir que o overlay seja removido
            console.error("Erro fatal na inicialização do Firebase em game.html:", error);
        });
    </script>
    <!-- Inclua o script da lógica do jogo (gameLogic.js) como um módulo -->
    <script type="module" src="js/gameLogic.js"></script>

    <!-- Container principal do jogo, inicialmente oculto com display: none via classe 'hidden' -->
    <div class="container hidden" id="gameContainer">
        <div class="w-full flex justify-between items-center mb-6">
            <h1 class="text-3xl font-extrabold text-teal-700">
                <span id="labelSession" data-lang-key="label_session">Sessão</span>: <span id="displaySessionId" class="text-green-600">Carregando...</span>
            </h1>
            <button id="backToHomeButton" class="game-button bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-lg shadow">
                <span data-lang-key="label_back_to_home">Voltar para o Início</span>
            </button>
        </div>

        <div class="session-info">
            <h2 data-lang-key="label_players">Jogadores na Sessão:</h2>
            <ul id="playerList" class="player-list">
                <li data-lang-key="no_players_in_session">Nenhum jogador ainda...</li>
            </ul>
        </div>

        <!-- Seletor de Área (inicialmente visível) -->
        <div id="gameAreaSelector" class="game-area-selector">
            <h2 data-lang-key="label_choose_area">Escolha a Área da Próxima Carta:</h2>
            <div id="areaButtons" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mt-4">
                <!-- Certifique-se de que os valores data-area correspondem ao campo 'area' no Firestore -->
                <button class="area-select-button bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4" data-area="Cronograma" data-lang-key="area_schedule">Cronograma</button>
                <button class="area-select-button bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4" data-area="Escopo" data-lang-key="area_scope">Escopo</button>
                <button class="area-select-button bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4" data-area="Qualidade" data-lang-key="area_quality">Qualidade</button>
                <!-- Adicione mais botões conforme as áreas no seu Firestore -->
                <!-- Exemplo para outras áreas, se existirem:
                <button class="area-select-button bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4" data-area="Integração" data-lang-key="area_integration">Integração</button>
                <button class="area-select-button bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4" data-area="Custo" data-lang-key="area_cost">Custo</button>
                <button class="area-select-button bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4" data-area="Recursos" data-lang-key="area_resources">Recursos</button>
                <button class="area-select-button bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4" data-area="Comunicação" data-lang-key="area_communications">Comunicações</button>
                <button class="area-select-button bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4" data-area="Riscos" data-lang-key="area_risks">Riscos</button>
                <button class="area-select-button bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4" data-area="Aquisições" data-lang-key="area_acquisitions">Aquisições</button>
                <button class="area-select-button bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4" data-area="Partes Interessadas" data-lang-key="area_stakeholders">Partes Interessadas</button>
                -->
            </div>
            <button id="randomCardButton" class="game-button bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg shadow-lg mt-6 w-full" data-lang-key="button_random_card">
                Carta Aleatória
            </button>
        </div>

        <!-- Carta do Jogo (inicialmente oculta) -->
        <div id="gameCard" class="card hidden">
            <div class="card-content">
                <h2 id="questionArea" class="text-2xl font-semibold mb-4 text-teal-800" data-lang-key="label_area_title">Área: Carregando...</h2>
                <p id="currentQuestionDisplay" class="text-xl font-medium mb-6">Aguardando a próxima pergunta...</p>
                <div id="optionsContainer" class="options-container">
                    <!-- As opções serão inseridas aqui via JavaScript -->
                </div>
                <button id="answerButton" class="game-button bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg w-full mt-6" data-lang-key="button_check_answer">
                    Verificar Resposta
                </button>
                <div id="feedbackContainer" class="mt-4">
                    <!-- Feedback e explicação serão inseridos aqui -->
                </div>
                <button id="nextCardButton" class="game-button bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg w-full mt-4 hidden" data-lang-key="button_next_card">
                    Próxima Carta
                </button>
            </div>
        </div>

        <div id="messageBox" class="message-box hidden"></div>
    </div>
    <div class="version-text">Versão: 1.0.2</div>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo de Gerenciamento de Projetos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #2c3e50;
        }
        h2 {
            font-size: 1.75rem;
            font-weight: 600;
            color: #34495e;
            margin-bottom: 1rem;
        }
        p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .player-info, .session-info {
            background-color: #e9ecef;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            text-align: left;
            font-size: 0.95rem;
            color: #495057;
            border: 1px solid #ced4da;
        }
        .player-list {
            list-style: none;
            padding: 0;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            background-color: #f8f9fa;
        }
        .player-list li {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-list li:last-child {
            border-bottom: none;
        }
        .player-list li span {
            font-weight: 500;
            color: #212529;
        }
        .game-section {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #dee2e6;
            text-align: left;
        }
        .message-box {
            background-color: #e0f2f7;
            border: 1px solid #a7d9ed;
            color: #0056b3;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            text-align: center;
            font-weight: 500;
            margin-left: auto;
            margin-right: auto;
            width: fit-content;
        }
        .message-box.error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .message-box.success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .button {
            background-color: #28a745;
            color: white;
            padding: 0.85rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 1.5rem;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2);
        }
        .button:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        .button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        .version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 0.8em;
            color: #777;
        }
        /* Estilos para as op√ß√µes de resposta */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .option-item {
            display: flex;
            align-items: center;
            background-color: #f0f0f0;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: 1px solid #e0e0e0;
        }
        .option-item:hover {
            background-color: #e5e5e5;
        }
        .option-item input[type="radio"] {
            margin-right: 0.75rem;
            transform: scale(1.2); /* Aumenta o tamanho do radio button */
        }
        .option-item label {
            flex-grow: 1;
            cursor: pointer;
            font-size: 1rem;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bem-vindo ao Jogo!</h1>
        <div class="session-info">
            <p><strong>ID da Sess√£o:</strong> <span id="displaySessionId">Carregando...</span></p>
            <p><strong>Idioma da Sess√£o:</strong> <span id="displayLanguage">Carregando...</span></p>
        </div>

        <div class="player-info">
            <p><strong>Seu ID de Usu√°rio:</strong> <span id="currentUserIdDisplay">Carregando...</span></p>
            <h2>Jogadores na Sess√£o:</h2>
            <ul id="playerList" class="player-list">
                <li>Nenhum jogador ainda...</li>
            </ul>
        </div>

        <div class="game-section">
            <h2>Pr√≥xima Pergunta:</h2>
            <p id="currentQuestionDisplay">Aguardando a pr√≥xima pergunta...</p>
            <div id="optionsContainer" class="options-container">
                <!-- As op√ß√µes ser√£o inseridas aqui via JavaScript -->
            </div>
            <button id="answerButton" class="button" disabled>Responder Pergunta</button>
        </div>

        <div id="messageBox" class="message-box hidden"></div>
    </div>
    <div class="version">Vers√£o: 1.0.0</div>

    <!-- Inclua o arquivo de configura√ß√£o PRIMEIRO -->
    <script src="config.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importa as fun√ß√µes Firebase necess√°rias
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, updateDoc, arrayUnion, arrayRemove, serverTimestamp, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Estas vari√°veis ser√£o preenchidas por config.js
        let app;
        let auth;
        let db;
        let firestore;
        let currentUserId = null;
        let currentSessionId = null;
        let currentSessionLanguage = null;
        let availableQuestions = []; // Array para armazenar perguntas carregadas
        let currentQuestionIndex = 0; // √çndice da pergunta atual
        let currentQuestionData = null; // Armazena os dados da pergunta atual para f√°cil acesso

        // Promessa para garantir que o Firebase est√° inicializado e autenticado
        window.firebaseInitializedPromise = new Promise(async (resolve) => {
            try {
                // As vari√°veis window.appId, window.firebaseConfig, window.initialAuthToken
                // j√° devem estar dispon√≠veis aqui, carregadas por config.js
                if (window.firebaseConfig && Object.keys(window.firebaseConfig).length > 0) {
                    app = initializeApp(window.firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    firestore = {
                        doc: doc,
                        setDoc: setDoc,
                        getDoc: getDoc,
                        collection: collection,
                        updateDoc: updateDoc,
                        arrayUnion: arrayUnion,
                        arrayRemove: arrayRemove,
                        serverTimestamp: serverTimestamp,
                        onSnapshot: onSnapshot,
                        query: query,
                        where: where,
                        getDocs: getDocs
                    };

                    window.db = db;
                    window.firestore = firestore;

                    if (window.initialAuthToken) {
                        await signInWithCustomToken(auth, window.initialAuthToken);
                        console.log("Firebase (game.html): Autenticado com token personalizado.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Firebase (game.html): Autenticado anonimamente.");
                    }

                    currentUserId = auth.currentUser.uid;
                    window.currentUserId = currentUserId;
                    document.getElementById('currentUserIdDisplay').textContent = currentUserId;
                    console.log(`Firebase (game.html): App inicializado e autenticado. ID do Usu√°rio: ${currentUserId}`);
                    resolve();
                } else {
                    console.error("Firebase Configura√ß√£o n√£o encontrada ou inv√°lida em game.html. Pulando a inicializa√ß√£o do Firebase.");
                    showMessage('Erro: Configura√ß√£o do Firebase n√£o encontrada. O jogo pode n√£o funcionar corretamente.', 'error');
                    resolve();
                }
            } catch (error) {
                console.error("Erro na inicializa√ß√£o ou autentica√ß√£o do Firebase em game.html:", error);
                showMessage(`Erro na inicializa√ß√£o do Firebase: ${error.message}`, 'error');
                resolve();
            }
        });

        const displaySessionId = document.getElementById('displaySessionId');
        const displayLanguage = document.getElementById('displayLanguage');
        const playerList = document.getElementById('playerList');
        const currentQuestionDisplay = document.getElementById('currentQuestionDisplay');
        const optionsContainer = document.getElementById('optionsContainer'); // Novo elemento para as op√ß√µes
        const answerButton = document.getElementById('answerButton');
        const messageBox = document.getElementById('messageBox');

        // Fun√ß√£o para mostrar mensagens tempor√°rias
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`; // Adiciona classes para estilo (info, error, success)
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
                messageBox.textContent = '';
            }, 5000); // Esconde ap√≥s 5 segundos
        }

        // Obt√©m o ID da sess√£o e o idioma da URL
        const urlParams = new URLSearchParams(window.location.search);
        currentSessionId = urlParams.get('session');
        currentSessionLanguage = urlParams.get('lang') || 'pt-BR'; // Define pt-BR como padr√£o se n√£o houver

        displaySessionId.textContent = currentSessionId;
        displayLanguage.textContent = currentSessionLanguage;

        // Fun√ß√£o para carregar perguntas do Firestore
        async function loadQuestions() {
            try {
                const questionsColRef = firestore.collection(db, `artifacts/${window.appId}/public/data/questions`);
                const q = firestore.query(questionsColRef, firestore.where('language', '==', currentSessionLanguage));
                const querySnapshot = await firestore.getDocs(q);

                availableQuestions = []; // Limpa perguntas anteriores
                querySnapshot.forEach((doc) => {
                    availableQuestions.push(doc.data());
                });

                if (availableQuestions.length > 0) {
                    currentQuestionIndex = 0; // Come√ßa da primeira pergunta
                    displayQuestion(availableQuestions[currentQuestionIndex]);
                    answerButton.disabled = false;
                    showMessage('Perguntas carregadas com sucesso!', 'success');
                } else {
                    currentQuestionDisplay.textContent = 'Nenhuma pergunta dispon√≠vel para este idioma.';
                    answerButton.disabled = true;
                    showMessage('Nenhuma pergunta encontrada. Por favor, adicione perguntas ao Firestore.', 'info');
                }
            } catch (error) {
                console.error("Erro ao carregar perguntas:", error);
                showMessage(`Erro ao carregar perguntas: ${error.message}`, 'error');
                currentQuestionDisplay.textContent = 'Erro ao carregar perguntas.';
                answerButton.disabled = true;
            }
        }

        // Fun√ß√£o para exibir uma pergunta e suas op√ß√µes
        function displayQuestion(question) {
            currentQuestionData = question; // Armazena a pergunta atual
            currentQuestionDisplay.textContent = question.question; // Altera para 'question' que √© o campo do texto principal
            optionsContainer.innerHTML = ''; // Limpa as op√ß√µes anteriores

            if (question.options) {
                // Converte o objeto de op√ß√µes em um array de [chave, valor] para iterar e ordenar
                const optionEntries = Object.entries(question.options).sort(); // Garante ordem A, B, C, D

                optionEntries.forEach(([key, value]) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option-item';

                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = 'answer'; // Mesmo nome para que apenas um possa ser selecionado
                    input.id = `option-${key}`;
                    input.value = key; // O valor ser√° 'A', 'B', 'C', 'D'

                    const label = document.createElement('label');
                    label.htmlFor = `option-${key}`;
                    label.textContent = `${key}) ${value}`;

                    optionDiv.appendChild(input);
                    optionDiv.appendChild(label);
                    optionsContainer.appendChild(optionDiv);
                });
            }
        }

        // Fun√ß√£o para obter a resposta selecionada pelo usu√°rio
        function getSelectedAnswer() {
            const selectedOption = document.querySelector('input[name="answer"]:checked');
            return selectedOption ? selectedOption.value : null;
        }

        // Fun√ß√£o principal para iniciar o jogo ap√≥s o Firebase estar pronto
        async function startGame() {
            await window.firebaseInitializedPromise;

            if (!db || !auth.currentUser || !currentSessionId) {
                showMessage('N√£o foi poss√≠vel iniciar o jogo: Firebase ou ID da sess√£o n√£o est√£o prontos.', 'error');
                return;
            }

            // Refer√™ncia ao documento da sess√£o
            const sessionDocRef = firestore.doc(db, `artifacts/${window.appId}/public/data/sessions`, currentSessionId);

            // Listener para as mudan√ßas na sess√£o em tempo real
            onSnapshot(sessionDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const sessionData = docSnap.data();
                    console.log("Dados da sess√£o atualizados:", sessionData);

                    // Atualiza a lista de jogadores
                    const players = sessionData.currentPlayers || [];
                    playerList.innerHTML = ''; // Limpa a lista existente
                    if (players.length > 0) {
                        players.forEach(player => {
                            const li = document.createElement('li');
                            // player.joinedAt √© um objeto Timestamp do Firestore, ent√£o .toDate() o converte
                            // para um objeto Date JavaScript, que tem toLocaleString().
                            const joinedDate = player.joinedAt ? new Date(player.joinedAt.seconds * 1000).toLocaleString() : 'N/A';
                            li.textContent = `ID: ${player.userId} (Conectado em: ${joinedDate})`;
                            playerList.appendChild(li);
                        });
                    } else {
                        const li = document.createElement('li');
                        li.textContent = 'Nenhum jogador ainda...';
                        playerList.appendChild(li);
                    }
                } else {
                    showMessage('Sess√£o n√£o encontrada ou encerrada.', 'error');
                    console.error("Sess√£o n√£o encontrada no Firestore.");
                }
            }, (error) => {
                console.error("Erro ao ouvir a sess√£o:", error);
                showMessage(`Erro ao carregar dados da sess√£o: ${error.message}`, 'error');
            });

            // Adiciona o jogador atual √† sess√£o, se ainda n√£o estiver l√°
            const addPlayerToSession = async () => {
                const docSnap = await firestore.getDoc(sessionDocRef);
                if (docSnap.exists()) {
                    const sessionData = docSnap.data();
                    const players = sessionData.currentPlayers || [];
                    const playerExists = players.some(player => player.userId === currentUserId);

                    if (!playerExists) {
                        await firestore.updateDoc(sessionDocRef, {
                            currentPlayers: firestore.arrayUnion({
                                userId: currentUserId,
                                joinedAt: new Date(),
                                score: 0
                            })
                        });
                        console.log(`Usu√°rio ${currentUserId} adicionado √† sess√£o.`);
                    } else {
                        console.log(`Usu√°rio ${currentUserId} j√° est√° na sess√£o.`);
                    }
                }
            };

            await addPlayerToSession();

            // Carrega as perguntas assim que o jogo inicia e o Firebase estiver pronto
            await loadQuestions();


            // Adiciona um listener para o bot√£o de resposta
            answerButton.addEventListener('click', () => {
                const selectedAnswer = getSelectedAnswer();
                if (!selectedAnswer) {
                    showMessage('Por favor, selecione uma op√ß√£o antes de responder.', 'info');
                    return;
                }

                if (currentQuestionData && selectedAnswer === currentQuestionData.correct) {
                    showMessage('Resposta CORRETA! üéâ', 'success');
                    // Aqui voc√™ pode adicionar l√≥gica para aumentar a pontua√ß√£o do jogador
                } else {
                    showMessage(`Resposta INCORRETA. A resposta correta era: ${currentQuestionData.correct}) ${currentQuestionData.options[currentQuestionData.correct]}`, 'error');
                    // Aqui voc√™ pode adicionar l√≥gica para diminuir a pontua√ß√£o ou registrar erros
                }

                // Carrega a pr√≥xima pergunta ap√≥s um pequeno atraso
                setTimeout(() => {
                    if (availableQuestions.length > 0) {
                        currentQuestionIndex = (currentQuestionIndex + 1) % availableQuestions.length;
                        displayQuestion(availableQuestions[currentQuestionIndex]);
                    } else {
                        showMessage('N√£o h√° mais perguntas para responder.', 'info');
                        answerButton.disabled = true;
                    }
                }, 1500); // 1.5 segundos de atraso para o usu√°rio ver a mensagem
            });
        }

        // Inicia o jogo
        startGame();

        // Opcional: Lidar com o usu√°rio saindo (por exemplo, fechando a aba)
        window.addEventListener('beforeunload', async () => {
            if (currentSessionId && currentUserId && db) {
                const sessionDocRef = firestore.doc(db, `artifacts/${window.appId}/public/data/sessions`, currentSessionId);
                try {
                    const docSnap = await firestore.getDoc(sessionDocRef);
                    if (docSnap.exists()) {
                        const sessionData = docSnap.data();
                        const players = sessionData.currentPlayers || [];
                        const playerToRemove = players.find(player => player.userId === currentUserId);

                        if (playerToRemove) {
                            await firestore.updateDoc(sessionDocRef, {
                                currentPlayers: firestore.arrayRemove(playerToRemove)
                            });
                            console.log(`Usu√°rio ${currentUserId} removido da sess√£o.`);
                        }
                    }
                } catch (error) {
                    console.error("Erro ao remover usu√°rio da sess√£o:", error);
                }
            }
        });
    </script>
</body>
</html>

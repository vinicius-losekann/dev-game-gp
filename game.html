<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo de Gerenciamento de Projetos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
            padding: 20px; /* Adiciona um pouco de padding para telas menores */
            box-sizing: border-box; /* Garante que o padding não adicione scrollbars */
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 900px; /* Aumenta a largura máxima para o jogo */
            width: 100%; /* Garante que ocupe a largura disponível */
            text-align: center;
            display: flex; /* Usa flexbox para o layout interno */
            flex-direction: column;
            gap: 1.5rem; /* Espaço entre os elementos principais */
        }
        h1 {
            font-size: 2.5rem; /* Aumenta o tamanho do título */
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #2c3e50;
        }
        h2 {
            font-size: 1.75rem;
            font-weight: 600;
            color: #34495e;
            margin-bottom: 1rem;
        }
        p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .player-info, .session-info {
            background-color: #e9ecef;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            text-align: left;
            font-size: 0.95rem;
            color: #495057;
            border: 1px solid #ced4da;
        }
        .player-list {
            list-style: none;
            padding: 0;
            max-height: 150px; /* Limita a altura e adiciona scroll */
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            background-color: #f8f9fa;
        }
        .player-list li {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-list li:last-child {
            border-bottom: none;
        }
        .player-list li span {
            font-weight: 500;
            color: #212529;
        }
        .game-section {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #dee2e6;
            text-align: left;
        }
        .message-box {
            background-color: #e0f2f7;
            border: 1px solid #a7d9ed;
            color: #0056b3;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            text-align: center;
            font-weight: 500;
            margin-left: auto;
            margin-right: auto;
            width: fit-content;
        }
        .message-box.error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .message-box.success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .button {
            background-color: #28a745;
            color: white;
            padding: 0.85rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 1.5rem;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2);
        }
        .button:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        .button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        .version {
            position: fixed; /* Fixa a posição */
            bottom: 10px;
            right: 10px;
            font-size: 0.8em;
            color: #777;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bem-vindo ao Jogo!</h1>
        <div class="session-info">
            <p><strong>ID da Sessão:</strong> <span id="displaySessionId">Carregando...</span></p>
            <p><strong>Idioma da Sessão:</strong> <span id="displayLanguage">Carregando...</span></p>
        </div>

        <div class="player-info">
            <p><strong>Seu ID de Usuário:</strong> <span id="currentUserIdDisplay">Carregando...</span></p>
            <h2>Jogadores na Sessão:</h2>
            <ul id="playerList" class="player-list">
                <li>Nenhum jogador ainda...</li>
            </ul>
        </div>

        <div class="game-section">
            <h2>Próxima Pergunta:</h2>
            <p id="currentQuestionDisplay">Aguardando a próxima pergunta...</p>
            <button id="answerButton" class="button" disabled>Responder Pergunta</button>
        </div>

        <div id="messageBox" class="message-box hidden"></div>
    </div>
    <div class="version">Versão: 1.0.0</div>

    <!-- Inclua o arquivo de configuração PRIMEIRO -->
    <script src="config.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importa as funções Firebase necessárias
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, updateDoc, arrayUnion, arrayRemove, serverTimestamp, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Estas variáveis serão preenchidas por config.js
        let app;
        let auth;
        let db;
        let firestore;
        let currentUserId = null;
        let currentSessionId = null;
        let currentSessionLanguage = null;

        // Promessa para garantir que o Firebase está inicializado e autenticado
        window.firebaseInitializedPromise = new Promise(async (resolve) => {
            try {
                // As variáveis window.appId, window.firebaseConfig, window.initialAuthToken
                // já devem estar disponíveis aqui, carregadas por config.js
                if (window.firebaseConfig && Object.keys(window.firebaseConfig).length > 0) {
                    app = initializeApp(window.firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    firestore = {
                        doc: doc,
                        setDoc: setDoc,
                        getDoc: getDoc,
                        collection: collection,
                        updateDoc: updateDoc,
                        arrayUnion: arrayUnion,
                        arrayRemove: arrayRemove,
                        serverTimestamp: serverTimestamp,
                        onSnapshot: onSnapshot,
                        query: query,
                        where: where,
                        getDocs: getDocs
                    };

                    window.db = db;
                    window.firestore = firestore;

                    if (window.initialAuthToken) {
                        await signInWithCustomToken(auth, window.initialAuthToken);
                        console.log("Firebase (game.html): Autenticado com token personalizado.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Firebase (game.html): Autenticado anonimamente.");
                    }

                    currentUserId = auth.currentUser.uid;
                    window.currentUserId = currentUserId;
                    document.getElementById('currentUserIdDisplay').textContent = currentUserId;
                    console.log(`Firebase (game.html): App inicializado e autenticado. ID do Usuário: ${currentUserId}`);
                    resolve();
                } else {
                    console.error("Firebase Configuração não encontrada ou inválida em game.html. Pulando a inicialização do Firebase.");
                    showMessage('Erro: Configuração do Firebase não encontrada. O jogo pode não funcionar corretamente.', 'error');
                    resolve();
                }
            } catch (error) {
                console.error("Erro na inicialização ou autenticação do Firebase em game.html:", error);
                showMessage(`Erro na inicialização do Firebase: ${error.message}`, 'error');
                resolve();
            }
        });

        const displaySessionId = document.getElementById('displaySessionId');
        const displayLanguage = document.getElementById('displayLanguage');
        const playerList = document.getElementById('playerList');
        const currentQuestionDisplay = document.getElementById('currentQuestionDisplay');
        const answerButton = document.getElementById('answerButton');
        const messageBox = document.getElementById('messageBox');

        // Função para mostrar mensagens temporárias
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`; // Adiciona classes para estilo (info, error, success)
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
                messageBox.textContent = '';
            }, 5000); // Esconde após 5 segundos
        }

        // Obtém o ID da sessão e o idioma da URL
        const urlParams = new URLSearchParams(window.location.search);
        currentSessionId = urlParams.get('session');
        currentSessionLanguage = urlParams.get('lang') || 'pt-BR'; // Define pt-BR como padrão se não houver

        displaySessionId.textContent = currentSessionId;
        displayLanguage.textContent = currentSessionLanguage;

        // Função principal para iniciar o jogo após o Firebase estar pronto
        async function startGame() {
            await window.firebaseInitializedPromise;

            if (!db || !auth.currentUser || !currentSessionId) {
                showMessage('Não foi possível iniciar o jogo: Firebase ou ID da sessão não estão prontos.', 'error');
                return;
            }

            // Referência ao documento da sessão
            const sessionDocRef = firestore.doc(db, `artifacts/${window.appId}/public/data/sessions`, currentSessionId);

            // Listener para as mudanças na sessão em tempo real
            onSnapshot(sessionDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const sessionData = docSnap.data();
                    console.log("Dados da sessão atualizados:", sessionData);

                    // Atualiza a lista de jogadores
                    const players = sessionData.currentPlayers || [];
                    playerList.innerHTML = ''; // Limpa a lista existente
                    if (players.length > 0) {
                        players.forEach(player => {
                            const li = document.createElement('li');
                            li.textContent = `ID: ${player.userId} (Conectado em: ${new Date(player.joinedAt.seconds * 1000).toLocaleString()})`;
                            playerList.appendChild(li);
                        });
                    } else {
                        const li = document.createElement('li');
                        li.textContent = 'Nenhum jogador ainda...';
                        playerList.appendChild(li);
                    }

                    // Atualiza a pergunta atual
                    if (sessionData.currentQuestion) {
                        currentQuestionDisplay.textContent = sessionData.currentQuestion;
                        answerButton.disabled = false;
                    } else {
                        currentQuestionDisplay.textContent = 'Aguardando a próxima pergunta...';
                        answerButton.disabled = true;
                    }
                } else {
                    showMessage('Sessão não encontrada ou encerrada.', 'error');
                    console.error("Sessão não encontrada no Firestore.");
                    // Opcional: Redirecionar para a página inicial
                    // setTimeout(() => window.location.href = 'index.html', 3000);
                }
            }, (error) => {
                console.error("Erro ao ouvir a sessão:", error);
                showMessage(`Erro ao carregar dados da sessão: ${error.message}`, 'error');
            });

            // Adiciona o jogador atual à sessão, se ainda não estiver lá
            const addPlayerToSession = async () => {
                const docSnap = await firestore.getDoc(sessionDocRef);
                if (docSnap.exists()) {
                    const sessionData = docSnap.data();
                    const players = sessionData.currentPlayers || [];
                    const playerExists = players.some(player => player.userId === currentUserId);

                    if (!playerExists) {
                        await firestore.updateDoc(sessionDocRef, {
                            currentPlayers: firestore.arrayUnion({
                                userId: currentUserId,
                                joinedAt: serverTimestamp(),
                                score: 0
                            })
                        });
                        console.log(`Usuário ${currentUserId} adicionado à sessão.`);
                    } else {
                        console.log(`Usuário ${currentUserId} já está na sessão.`);
                    }
                }
            };

            addPlayerToSession();

            // Adiciona um listener para o botão de resposta (exemplo)
            answerButton.addEventListener('click', () => {
                showMessage('Você respondeu à pergunta! (Funcionalidade a ser implementada)', 'info');
                // Aqui você adicionaria a lógica para enviar a resposta ao Firestore
            });
        }

        // Inicia o jogo
        startGame();

        // Opcional: Lidar com o usuário saindo (por exemplo, fechando a aba)
        window.addEventListener('beforeunload', async () => {
            if (currentSessionId && currentUserId && db) {
                const sessionDocRef = firestore.doc(db, `artifacts/${window.appId}/public/data/sessions`, currentSessionId);
                try {
                    await firestore.updateDoc(sessionDocRef, {
                        currentPlayers: firestore.arrayRemove({ userId: currentUserId, /* outros dados do jogador */ })
                    });
                    console.log(`Usuário ${currentUserId} removido da sessão.`);
                } catch (error) {
                    console.error("Erro ao remover usuário da sessão:", error);
                }
            }
        });

    </script>

    <!-- Seu script principal do jogo (game.js) se tiver um, deve vir DEPOIS de toda a inicialização do Firebase -->
    <!-- <script src="js/game.js"></script> -->
</body>
</html>
